services:
  # ─── Backend: NestJS API ────────────────────────────
  - type: web
    name: atlasderslik-api
    runtime: node
    region: frankfurt
    plan: free
    rootDir: apps/api
    buildCommand: cd ../.. && npm install -g pnpm@10.2.0 && pnpm install --frozen-lockfile && pnpm --filter @repo/shared build && pnpm --filter api build
    startCommand: node dist/main.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: MONGO_URI
        sync: false  # Set manually in Render dashboard
      - key: JWT_SECRET
        sync: false  # Set manually in Render dashboard
      - key: CORS_ORIGIN
        sync: false  # Set to your frontend Render URL after deploy

  # ─── Frontend: Next.js ──────────────────────────────
  - type: web
    name: atlasderslik-web
    runtime: node
    region: frankfurt
    plan: free
    rootDir: apps/web
    buildCommand: cd ../.. && npm install -g pnpm@10.2.0 && pnpm install --frozen-lockfile && pnpm --filter @repo/shared build && pnpm --filter @repo/ui build && pnpm --filter web build && cp -r apps/web/.next/static apps/web/.next/standalone/apps/web/.next/static && cp -r apps/web/public apps/web/.next/standalone/apps/web/public
    startCommand: node .next/standalone/apps/web/server.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: HOSTNAME
        value: 0.0.0.0
      - key: NEXT_PUBLIC_API_URL
        sync: false  # Set to your API Render URL after deploy
